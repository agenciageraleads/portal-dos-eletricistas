version: "3.8"
services:
  # ==========================================
  # 1. FRONTEND WEB (Exposto via Traefik)
  # ==========================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    image: lucasborgessb/portal_dos_eletricistas:web-1.1.0
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portal_web.rule=Host(`app.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_web.entrypoints=websecure"
        - "traefik.http.routers.portal_web.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_web.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      # Aponta para o proxy interno do Traefik
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    networks:
      - portal_overlay
      - Portainer
  # ==========================================
  # 2. BACKEND API (Interno + Rota /api)
  # ==========================================
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: lucasborgessb/portal_dos_eletricistas:api-1.1.0
    command: >
      sh -c "npx prisma migrate deploy && node dist/src/main.js"
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        # Regra: Host Exclusivo para API
        - "traefik.http.routers.portal_api.rule=Host(`api.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_api.entrypoints=websecure"
        - "traefik.http.routers.portal_api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_api.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      PORT: ${PORT}
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: ${DATABASE_URL}
      # S3 / MinIO Configuration (Corrigido com nome do Bucket REAL)
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
    networks:
      - portal_overlay
      - Portainer
    depends_on:
      - db
  # ==========================================
  # 3. POSTGRES 14 (BANCO DEDICADO)
  # ==========================================
  db:
    image: postgres:14
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    deploy:
      mode: replicated
      replicas: 1
    networks:
      - portal_overlay
# ==========================================
# REDES E VOLUMES
# ==========================================
networks:
  portal_overlay:
    driver: overlay
  Portainer:
    external: true
volumes:
  db_data:
