version: "3.8"
services:
  # ==========================================
  # 1. FRONTEND WEB PRODUCTION
  # ==========================================
  web-prod:
    image: ghcr.io/agenciageraleads/portal-dos-eletricistas:web-prod
    deploy:
      mode: replicated
      replicas: 2 # Alta disponibilidade para produção
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portal_web_prod.rule=Host(`app.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_web_prod.entrypoints=websecure"
        - "traefik.http.routers.portal_web_prod.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_web_prod.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.portaleletricos.com.br
    networks:
      - portal_prod_overlay
      - Portainer

  # ==========================================
  # 2. BACKEND API PRODUCTION
  # ==========================================
  api-prod:
    image: ghcr.io/agenciageraleads/portal-dos-eletricistas:api-prod
    deploy:
      mode: replicated
      replicas: 2 # Alta disponibilidade para produção
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portal_api_prod.rule=Host(`api.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_api_prod.entrypoints=websecure"
        - "traefik.http.routers.portal_api_prod.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_api_prod.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      PORT: 3000
      JWT_SECRET: ${PROD_JWT_SECRET}
      DATABASE_URL: postgresql://${PROD_DB_USER}:${PROD_DB_PASSWORD}@db-prod:5432/${PROD_DB_NAME}?schema=public

      # S3/MinIO
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: portal-prod
      S3_REGION: ${S3_REGION}

      # Sankhya Integration
      SANKHYA_CLIENT_ID: ${SANKHYA_CLIENT_ID}
      SANKHYA_CLIENT_SECRET: ${SANKHYA_CLIENT_SECRET}
      SANKHYA_X_TOKEN: ${SANKHYA_X_TOKEN}

      # Evolution API (WhatsApp)
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      EVOLUTION_INSTANCE_NAME: ${EVOLUTION_INSTANCE_NAME}

      # Email
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}

      # Frontend
      FRONTEND_URL: https://app.portaleletricos.com.br

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes:
      - portal_uploads_prod:/app/uploads
    networks:
      - portal_prod_overlay
      - Portainer
    depends_on:
      - db-prod

  # ==========================================
  # 3. POSTGRES PRODUCTION
  # ==========================================
  db-prod:
    image: postgres:14
    volumes:
      - db_prod_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${PROD_DB_USER}
      POSTGRES_PASSWORD: ${PROD_DB_PASSWORD}
      POSTGRES_DB: ${PROD_DB_NAME}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PROD_DB_USER} -d ${PROD_DB_NAME}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      mode: replicated
      replicas: 1
    networks:
      - portal_prod_overlay

networks:
  portal_prod_overlay:
    driver: overlay
  Portainer:
    external: true

volumes:
  db_prod_data:
  portal_uploads_prod:
