version: "3.8"
services:
  # ==========================================
  # 1. FRONTEND WEB (Exposto via Traefik)
  # ==========================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    image: lucasborgessb/portal_dos_eletricistas:web-latest
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portal_web.rule=Host(`app.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_web.entrypoints=websecure"
        - "traefik.http.routers.portal_web.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_web.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      # Aponta para o proxy interno do Traefik
      NEXT_PUBLIC_API_URL: /api
    networks:
      - portal_overlay
      - Portainer
  # ==========================================
  # 2. BACKEND API (Interno + Rota /api)
  # ==========================================
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: lucasborgessb/portal_dos_eletricistas:api-latest
    command: >
      sh -c "npx prisma migrate deploy && node dist/src/main.js"
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        # Regra: Host Exclusivo para API
        - "traefik.http.routers.portal_api.rule=Host(`api.portaleletricos.com.br`)"
        - "traefik.http.routers.portal_api.entrypoints=websecure"
        - "traefik.http.routers.portal_api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.portal_api.loadbalancer.server.port=3000"
        - "traefik.docker.network=Portainer"
    environment:
      NODE_ENV: production
      PORT: 3000
      JWT_SECRET: super_chave_secreta_mude_depois
      DATABASE_URL: postgres://portal:portal_senha_forte@db:5432/portal_eletricistas?schema=public
      # S3 / MinIO Configuration (Corrigido com nome do Bucket REAL)
      S3_ENDPOINT: https://s3.gera-leads.com
      S3_ACCESS_KEY: admin
      S3_SECRET_KEY: Lucas132395
      S3_BUCKET: portal-produtos # <--- Nome que estÃ¡ no seu print
      S3_REGION: us-east-1
    networks:
      - portal_overlay
      - Portainer
    depends_on:
      - db
  # ==========================================
  # 3. POSTGRES 14 (BANCO DEDICADO)
  # ==========================================
  db:
    image: postgres:14
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: portal
      POSTGRES_PASSWORD: portal_senha_forte
      POSTGRES_DB: portal_eletricistas
    deploy:
      mode: replicated
      replicas: 1
    networks:
      - portal_overlay
# ==========================================
# REDES E VOLUMES
# ==========================================
networks:
  portal_overlay:
    driver: overlay
  Portainer:
    external: true
volumes:
  db_data:
