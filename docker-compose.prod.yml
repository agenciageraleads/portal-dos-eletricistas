version: '3.8'

services:
  # Backend API
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: portal_api
    restart: unless-stopped
    ports:
      - "3333:3333"
    environment:
      # CONFIGURAR: IP do host ou nome do container do banco existente
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}?schema=public
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3333
      FRONTEND_URL: ${FRONTEND_URL}
      NODE_ENV: production
      # S3 / MinIO
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_BUCKET_NAME: ${AWS_BUCKET_NAME:-portal-produtos}
      AWS_ENDPOINT: ${AWS_ENDPOINT}
      AWS_PUBLIC_URL: ${AWS_PUBLIC_URL}
    # Se o banco estiver em outra rede Docker, descomente e ajuste:
    # networks:
    #   - portal_network
    #   - sua_rede_banco_existente

    # Frontend Web
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: portal_web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
      NEXT_PUBLIC_POSTHOG_HOST: ${NEXT_PUBLIC_POSTHOG_HOST}
      NODE_ENV: production
    depends_on:
      - api
    # Labels para Traefik (Exemplo - Ajuste conforme sua config)
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.portal.rule=Host(`portal.seudominio.com`)"
    #   - "traefik.http.routers.portal.entrypoints=websecure"

    # networks:
    #   portal_network:
    #     driver: bridge
